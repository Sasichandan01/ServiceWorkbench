AWSTemplateFormatVersion: '2010-09-09'
Description: Development cloudFormation template for the Service Workbench V2
Transform: 'AWS::Serverless-2016-10-31'

Parameters:
  pPrefix:
    Type: String
    Default: "develop"
    Description: Prefix for Lambda function naming

  ppLambdaArtifactVersion:
    Type: String
    Description: S3 path version folder for Lambda artifacts
  
  # pGlueArtifactVersion:
  #   Type: String
  #   Description: S3 path version folder for Glue artifacts

  ppApiName:
    Type: String
    Default: WorkbenchAPI
    Description: Name of the API Gateway API

  ppVPCPrefix:
    Type: String
    Default: WorkbenchVPC
    Description: Environment name prefix for VPC resources

  pArtifactsBucketName:
    Type: String
    Default: "service-workbench-artifacts"
    Description: Name of the S3 bucket for artifacts

  pRAGPrefix:
    Type: String
    Default: "develop"
    Description: rag-prefix
  
  pprDeploymentTrigger:
    Type: String
    Default: "2025-07-02T00:00:00Z"
    Description: Trigger date for deployment, used for versioning

  prWebSocketStage:
    Type: String
    Default: "prod"
    Description: "Stage name for websocket api"

  pTablesDataPrefix:
    Type: String
    Default: "tables"
    Description: "Prefix for stroing ddb data in s3"

  pWebScrapDocumentsPrefix:
    Type: String
    Default: "webscrap"
    Description: "Prefix for storing web scraping data into s3"
Resources:

  # S3 Bucket for artifacts
  rMiscBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${pPrefix}-service-workbench-misc"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: ["GET", "PUT", "POST", "DELETE"]
            AllowedOrigins: ["*"]
            ExposedHeaders: ["ETag"]
            MaxAge: 3000
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rMiscBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref rMiscBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub "${rMiscBucket.Arn}/*"


  # CloudFront Origin Access Control (OAC)
  rWebsiteOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${pPrefix}-service-workbench-oac"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

# CloudFront Distribution
  rWebsiteDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !ImportValue WebsiteBucketRegionalDomainName
            S3OriginConfig: {}
            OriginAccessControlId: !Ref rWebsiteOAC
            OriginPath: !Sub "/${pPrefix}-web"
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          CachedMethods: [GET, HEAD, OPTIONS]
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        Logging:
          Bucket: !ImportValue LogsBucketDomainName
          Prefix: !Sub "${pPrefix}-cloudfront-logs/"
          IncludeCookies: false
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
        PriceClass: PriceClass_100
        HttpVersion: http2
        IPV6Enabled: true
      Tags:
        - Key: Name
          Value: "ServiceWorkbench"
        - Key: SWB-User
          Value: "ServiceWorkbench"

# S3 Bucket Policy to allow CloudFront OAC access only
  rWebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !ImportValue WebsiteBucketName
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub
              - "arn:aws:s3:::${BucketName}/*"
              - {BucketName: !ImportValue WebsiteBucketName}

# Bucket policy to allow CloudFront to write logs
  rCloudFrontLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !ImportValue LogsBucketName
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub
              - "arn:aws:s3:::${BucketName}/*"
              - {BucketName: !ImportValue LogsBucketName}
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${rWebsiteDistribution}'
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !ImportValue LogsBucketArn
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${rWebsiteDistribution}'

# Cognito User Pool and Client
  rUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${pPrefix}-UserPool"
      AliasAttributes:
        - email
        - preferred_username
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: preferred_username
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: Role
          AttributeDataType: String
          Required: false
          Mutable: true
      AutoVerifiedAttributes:
        - email
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
        InviteMessageTemplate:
          EmailSubject: "Your temporary password for WorkBench"
          EmailMessage: "Your username is {username} and temporary password is {####}"
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: true
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      VerificationMessageTemplate:
        DefaultEmailOption: CONFIRM_WITH_CODE
        EmailSubject: "Your verification code for WorkBench"
        EmailMessage: "Your verification code is {####}"

  rUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${pPrefix}-Client"
      UserPoolId: !Ref rUserPool
      GenerateSecret: false
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        AccessToken: "minutes"
        IdToken: "minutes"
        RefreshToken: "days"
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_CUSTOM_AUTH
      SupportedIdentityProviders:
        - COGNITO
      PreventUserExistenceErrors: ENABLED

  rUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref rUserPool
      Domain: !Sub "${pPrefix}-${AWS::AccountId}-auth"
      ManagedLoginVersion: "2"

  rCleanupDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${pPrefix}-CleanupDLQ"
      MessageRetentionPeriod: 1209600  # 14 days
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
    
  rCognitoTriggersCustomResource:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${pprDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-CognitoTriggersCustomResource"
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Lambda-SG-ID"
      Role: !GetAtt rrCustomResourceLambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${ppLambdaArtifactVersion}-${pPrefix}/workbenchcognitocustomresourcelambda/WorkbenchCognitoCustomResource.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rCognitoTriggersResource:
    Type: Custom::CognitoTriggers
    Properties:
      ServiceToken: !GetAtt rCognitoTriggersCustomResource.Arn
      UserPoolId: !Ref rUserPool
      PreSignUpLambdaArn: !GetAtt rPreSignUpFunction.Arn
      PreAuthLambdaArn: !GetAtt rrPreAuthFunction.Arn
      PreTokenLambdaArn: !GetAtt rrPreTokenGenerationFunction.Arn
      PostConfirmationLambdaArn: !GetAtt rrPostConfirmationFunction.Arn
      PostAuthLambdaArn: !GetAtt rrPostAuthFunction.Arn
      Changesetflag: "2025-07-02"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPreSignUpFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${pprDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-PreSignUp"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rrUserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${ppVPCPrefix}-Lambda-SG-ID"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${ppLambdaArtifactVersion}-${pPrefix}/workbenchpresignuplambda/WorkbenchPresignup.zip"
      Environment:
        Variables:
          QUEUE_URL: !Ref rrCleanupQueue
          USER_TABLE_NAME: !Ref rrUserTable
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPreAuthFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-PreAuth"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rUserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchpreauthlambda/WorkbenchPreAuth.zip"
      Environment:
        Variables:
          USER_TABLE_NAME: !Ref rUserTable
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPreTokenGenerationFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-PreTokenGen"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rUserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchpretokengenerationlambda/WorkbenchPreTokengeneration.zip"
      Environment:
        Variables:
          USER_TABLE_NAME: !Ref rUserTable
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPostConfirmationFunction:
    Type: AWS::Lambda::Function
    Properties: 
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-PostConfirm"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rUserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchpostconfirmationlambda/WorkbenchPostConfirmation.zip"
      Environment:
        Variables:
          USER_TABLE_NAME: !Ref rUserTable
          USERS_TABLE: !Ref rUserTable
          ROLE_TABLE_NAME: !Ref rRolesTable
          DOMAIN: "ServiceWorkbench v2.0"
          SOURCE_EMAIL: "mayank.gupta@cloudwick.com"
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          WORKSPACES_TABLE_NAME: !Ref rWorkspacesTable
          RESOURCE_ACCESS_TABLE: !Ref rResourceAccessTable

      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPostAuthFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-PostAuth"
      Role: !GetAtt rUserExecutionRole.Arn
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchpostauthlambda/WorkbenchPostAuth.zip"
      Environment:
        Variables:
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          USERS_TABLE: !Ref rUserTable
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rUserPoolCleanUp:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-Workbench-UserPool"
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      Timeout: 60
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Role: !GetAtt rUserExecutionRole.Arn
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchuserpoolcleanuplambda/WorkbenchUserpoolCleanup.zip"
      Environment:
        Variables:
          QUEUE_URL: !Ref rCleanupQueue
          USER_POOL_ID: !Ref UserPool
          USER_TABLE_NAME: !Ref rUserTable
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rPreSignUpPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt PreSignUpFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

  rPreAuthPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt rPreAuthFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

  rPreTokenPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt rPreTokenGenerationFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

  rPostConfirmPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt rPostConfirmationFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn
  
  rPostAuthPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt rPostAuthFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

# Event Source Mapping for Cleanup Queue
  rrCleanupQueueEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      Enabled: true
      EventSourceArn: !GetAtt rCleanupQueue.Arn
      FunctionName: !GetAtt rUserPoolCleanUp.Arn
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

# Main SQS queue with redrive policy
  rCleanupQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${pPrefix}-rCleanupQueue"
      VisibilityTimeout: 65
      ReceiveMessageWaitTimeSeconds: 20
      DelaySeconds: 900
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt CleanupDLQ.Arn
        maxReceiveCount: 5  # Message is sent to DLQ after 5 failed receives
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  # IAM Role for the Custom Resource Lambda
  rCustomResourceLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CognitoAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:UpdateUserPool
                Resource: !GetAtt UserPool.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rBedrockAgentLookupTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${pPrefix}-BedrockAgentLookup-Table"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: AgentId
          AttributeType: S
      KeySchema:
        - AttributeName: AgentId
          KeyType: HASH
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rBedrockAgentExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rBedrockAgentExecutionRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BedrockAgentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"

  rCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-BedrockrCustomResourceRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: BedrockAgentManagement
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${pPrefix}-BedrockAgentLookup-Table"
              - Effect: Allow
                Action:
                  - lambda:AddPermission
                  - lambda:RemovePermission
                Resource: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt rBedrockAgentExecutionRole.Arn

  rBedrockAgentCustomResource:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${pPrefix}-AgentCustomResourceLambda"
      Runtime: python3.11
      Handler: AgentCustomResourceLambda.lambda_handler
      Role: !GetAtt rCustomResourceRole.Arn
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          ENVIRONMENT: !Sub "${pPrefix}"
          AGENTS_TABLE_NAME: !Sub "${pPrefix}-BedrockAgentLookup-Table"
          AGENT_EXECUTION_ROLE: !GetAtt rBedrockAgentExecutionRole.Arn
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          KNOWLEDGE_BASE_ID: !Ref rVectorKnowledgeBase
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/agentcustomresourcelambda/AgentCustomResourceLambda.zip"
      Layers:
        - arn:aws:lambda:us-east-1:043309350924:layer:yaml-layer:1

  rCodeGenerationLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rCodeGenerationLambda"
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Role: !GetAtt rArchitectureAgentAGLambdaRole.Arn
      Timeout: 300
      MemorySize: 1024
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/codegenerationlambda/rCodeGenerationLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"


  rBedrockAgentManager:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt rBedrockAgentCustomResource.Arn 
      Environment: !Sub "${pPrefix}"
      Version: "1.0"
      Changesetflag: "19-19-19"

  rUserExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudwatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CloudWatchLogsAccess
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
        
        - PolicyName: SQSPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SQSPutPolicies
                Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource: !GetAtt rCleanupQueue.Arn
        
        - PolicyName: DynamoDBPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: DynamoDBActivityLogsAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*"
        
        - PolicyName: CognitoPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CognitoAccess
                Effect: Allow
                Action:
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:AdminGetUser
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminUpdateUserAttributes
                Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPool}"
        
        - PolicyName: SESPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SESAccess
                Effect: Allow
                Action:
                  - ses:SendEmail
                Resource: "*"

        - PolicyName: S3Policies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: S3PutAccess
                Effect: Allow
                Action:
                  - s3:PutObject
                Resource: "*"
        
        - PolicyName: SSMPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SSMAccess
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:PutParameter
                Resource: "*"
      
        - PolicyName: rGlueJobPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: rGlueJobAccess
                Effect: Allow
                Action:
                  - glue:StartJobRun
                Resource:
                  - !Sub "arn:aws:glue:${AWS::Region}:${AWS::AccountId}:job/${rGlueJob}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rRolesLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rRolesLambdaExecutionRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Scan
                  - dynamodb:DeleteItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
  
  rWorkspaceLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rWorkspaceLambdaExecutionRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaBasicExecution
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*
                  - !Sub arn:aws:dynamodb:us-east-1:043309350924:table/Wokbench-chathistory
                  - !Sub arn:aws:dynamodb:us-east-1:043309350924:table/Wokbench-chathistory/index/MessageIdIndex
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !ImportValue WorkspacesBucketArn
                  - !Sub
                    - "${BucketArn}/*"
                    - {BucketArn: !ImportValue WorkspacesBucketArn}
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: 
                  - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*
              - Effect: Allow
                Action: glue:StartJobRun
                Resource: '*'
              - Effect: Allow
                Action: states:StartExecution
                Resource: '*'
        - PolicyName: LogAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowLogsAndGlueAccess
                Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:GetLogEvents
                  - glue:*
                  - logs:FilterLogEvents
                Resource: '*'
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::develop-service-workbench-workspaces/*"
                  - !Sub "arn:aws:s3:::develop-service-workbench-workspaces"

      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rChatLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-ChatLambdaExecutionRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowLogsAndGlueAccess
                Effect: Allow
                Action:
                  - bedrock:InvokeAgent
                Resource: '*'     
        - PolicyName: WebSocketAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:ManageConnections
                Resource: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWebSocketApi}/*"
        - PolicyName: DDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowDDBAccess
                Effect: Allow
                Action:
                  - dynamodb:Scan
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${pPrefix}-BedrockAgentLookup-Table"
              - Sid: DynamoDBActivityLogsAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*"
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !ImportValue WorkspacesBucketArn
                  - !Sub
                    - "${BucketArn}/*"
                    - {BucketArn: !ImportValue WorkspacesBucketArn}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rrGlueJobRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rrGlueJobRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub "arn:aws:s3:::${pPrefix}-service-workbench-misc/*"
                  - !Sub "arn:aws:s3:::${pPrefix}-service-workbench-misc"
                  - !Sub "arn:aws:s3:::service-workbench-artifacts"
                  - !Sub "arn:aws:s3:::service-workbench-artifacts/*"
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:GetKnowledgeBase
                  - bedrock:GetDataSource
                  - bedrock:StartIngestionJob
                  - bedrock:GetIngestionJob
                  - bedrock:ListIngestionJobs
                Resource:
                  - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${rVectorKnowledgeBase}"
                  - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${rAuroraKnowledgeBase}"
        - PolicyName: CloudWatchAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
        - PolicyName: LogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
        - PolicyName: DynamoDBReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:DescribeTable
                  - dynamodb:ListStreams
                  - dynamodb:ExportTableToPointInTime
                  - dynamodb:DescribeExport
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-${pPrefix}-*"
              - Effect: Allow
                Action:
                  - dynamodb:ListTables
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/*"
 

  rAuroraDataSource:
    Type: AWS::Bedrock::DataSource
    Properties:
      KnowledgeBaseId: !Ref rAuroraKnowledgeBase
      Name: !Sub "${pPrefix}-Aurora-datasource"
      Description: 'Data source for DynamoDB synced data'
      DataSourceConfiguration:
        Type: 'S3'
        S3Configuration:
          BucketArn: !Sub "arn:aws:s3:::${pPrefix}-service-workbench-misc"  
          InclusionPrefixes:
            - !Ref pTablesDataPrefix
      VectorIngestionConfiguration:
        ChunkingConfiguration:
          ChunkingStrategy: 'FIXED_SIZE'
          FixedSizeChunkingConfiguration:
            MaxTokens: 300
            OverlapPercentage: 20

  rOpensearchDataSource:
    Type: AWS::Bedrock::DataSource
    Properties:
      KnowledgeBaseId: !Ref rVectorKnowledgeBase
      Name: !Sub "${pPrefix}-Opensearch-datasource"
      Description: "S3 data source for documents"
      DataSourceConfiguration:
        Type: S3
        S3Configuration:
          BucketArn: !Sub "arn:aws:s3:::${pPrefix}-service-workbench-misc"  
          InclusionPrefixes:
            - !Ref pWebScrapDocumentsPrefix
      VectorIngestionConfiguration:
        ChunkingConfiguration:
          ChunkingStrategy: FIXED_SIZE
          FixedSizeChunkingConfiguration:
            MaxTokens: 300
            OverlapPercentage: 20

  rGlueJob:
    Type: AWS::Glue::Job
    Properties:
      Name: !Sub "${pPrefix}-Workbench-RAGSync"
      Role: !GetAtt rrGlueJobRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub "s3://service-workbench-artifacts/glue/ragsyncgluejob/RAGSyncrGlueJob.py"
        PythonVersion: '3'
      DefaultArguments:
        '--job-language': 'python'
        '--job-bookmark-option': 'job-bookmark-disable'
        '--enable-metrics': 'true'
        '--enable-continuous-cloudwatch-log': 'true'
        '--enable-continuous-log-filter': 'true'
        '--DYNAMODB_TABLE_PREFIX': !Sub "Workbench-${pPrefix}"
        '--AURORA_KB_ID': !Ref rAuroraKnowledgeBase
        '--AURORA_DS_ID': !Ref rAuroraDataSource
        '--OPENSEARCH_KB_ID': !Ref rVectorKnowledgeBase
        '--OPENSEARCH_DS_ID': !Ref rOpensearchDataSource
        '--OPENSEARCH_S3_BUCKET': !Sub "${pPrefix}-service-workbench-misc"
        '--OPENSEARCH_S3_PREFIX': !Ref pWebScrapDocumentsPrefix
        '--AURORA_S3_BUCKET': !Sub "${pPrefix}-service-workbench-misc"
        '--AURORA_S3_PREFIX': !Ref pTablesDataPrefix
        '--ACTION': 'docsapp'
        '--WAIT_FOR_SYNC': 'true'
        '--AWS_REGION': !Ref AWS::Region
        '--AWS_ACCOUNT_ID': !Ref AWS::AccountId
        "--additional-python-modules": "boto3>=1.28.32,botocore>=1.31.32,requests==2.31.0,beautifulsoup4>=4.12.3"
      GlueVersion: '4.0'
      MaxCapacity: 10
      MaxRetries: 1
      Timeout: 2880
      Description: 'Sync DynamoDB tables to Knowledge Base via S3'


  rLambdaAuthorizerFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-LambdaAuthorizer"
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Role: !GetAtt rUserExecutionRole.Arn
      Code:
        S3Bucket: "service-workbench-artifacts"
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchlambdaauthorizerlambda/WorkbenchLambdaAuthorizer.zip"
      Environment:
        Variables:
          USER_POOL_ID: !Ref UserPool
          USERS_TABLE: !Ref rUserTable
          CLIENT_ID: !Ref UserPoolClient
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench" 

  rWorkspacesAndSolutionsLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-workspacesandsolutions-lambda"
      Handler: WorkspacesAndSolutionsLambda.lambda_handler
      Role: !GetAtt rWorkspaceLambdaExecutionRole.Arn
      Runtime: python3.13
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Environment:
        Variables:
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          SOLUTIONS_TABLE: !Ref rSolutionsTable
          TEMPLATES_TABLE: !Ref rTemplatesTable
          WORKSPACES_TABLE: !Ref rWorkspacesTable
          EXECUTIONS_TABLE: !Ref rSolutionExecutionsTable
          DATASOURCES_TABLE: !Ref rDatasourcesTable
          ROLES_TABLE: !Ref rRolesTable
          RESOURCE_ACCESS_TABLE: !Ref rResourceAccessTable
          WORKSPACES_BUCKET: !ImportValue WorkspacesBucket
          USERS_TABLE: !Ref rUserTable
          CHAT_TABLE: "Wokbench-chathistory"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workspacesandsolutionslambda/WorkspacesAndSolutionsLambda.zip"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Timeout: 900
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
  
  rDatasourceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${pPrefix}-datasource-bucket"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: ["GET", "PUT", "POST", "DELETE"]
            AllowedOrigins: ["*"]
            ExposedHeaders: ["ETag"]
            MaxAge: 3000
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
  
  rrDatasourceBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref rDatasourceBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub "${rDatasourceBucket.Arn}/*" 

  # API Gateway
  rWorkbenchApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${pPrefix}-${pApiName}"
      StageName: prod
      DefinitionUri:
        Bucket: !Ref pArtifactsBucketName
        Key: develop/swagger.yaml
      EndpointConfiguration: REGIONAL
      AlwaysDeploy: True
      Description: !Sub "${prDeploymentTrigger}"

  rWorkspacerLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rWorkspacesAndSolutionsLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*/*/*'

  rUserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "Workbench-${pPrefix}-rUserTable"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserId
          AttributeType: S
        - AttributeName: Email
          AttributeType: S
      KeySchema:
        - AttributeName: UserId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: Email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rActivityLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "Workbench-${pPrefix}-rActivityLogsTable"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: LogId
          AttributeType: S
        - AttributeName: UserId
          AttributeType: S
      KeySchema:
        - AttributeName: LogId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserId-Index
          KeySchema:
            - AttributeName: UserId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rWorkspacesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rWorkspacesTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: WorkspaceId
          AttributeType: S
        - AttributeName: WorkspaceName
          AttributeType: S
        - AttributeName: CreatedBy
          AttributeType: S
      KeySchema:
        - AttributeName: WorkspaceId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CreatedBy-index
          KeySchema:
            - AttributeName: CreatedBy
              KeyType: HASH
            - AttributeName: WorkspaceName
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rSolutionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rSolutionsTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: WorkspaceId
          AttributeType: S
        - AttributeName: SolutionId
          AttributeType: S
      KeySchema:
        - AttributeName: WorkspaceId
          KeyType: HASH
        - AttributeName: SolutionId
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rDatasourcesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rDatasourcesTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: DatasourceId
          AttributeType: S
        - AttributeName: DatasourceName
          AttributeType: S
        - AttributeName: CreatedBy
          AttributeType: S
      KeySchema:
        - AttributeName: DatasourceId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CreatedBy-DatasourceName-index
          KeySchema:
            - AttributeName: CreatedBy
              KeyType: HASH
            - AttributeName: DatasourceName
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: DatasourceName-index
          KeySchema:
            - AttributeName: DatasourceName
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
 
  rResourceAccessTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rResourceAccessTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Id
          AttributeType: S
        - AttributeName: AccessKey
          AttributeType: S
      KeySchema:
        - AttributeName: Id
          KeyType: HASH
        - AttributeName: AccessKey
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: AccessKey-Index
          KeySchema:
            - AttributeName: AccessKey
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rSolutionExecutionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rSolutionExecutionsTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: SolutionId
          AttributeType: S
        - AttributeName: ExecutionId
          AttributeType: S
      KeySchema:
        - AttributeName: SolutionId
          KeyType: HASH
        - AttributeName: ExecutionId
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
 
  rTemplatesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rTemplatesTable'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: SolutionId
          AttributeType: S
        - AttributeName: Version
          AttributeType: S
      KeySchema:
        - AttributeName: SolutionId
          KeyType: HASH
        - AttributeName: Version
          KeyType: RANGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rRolesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-rRolesTable'
      AttributeDefinitions:
        - AttributeName: Role
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: Role
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: 'true'
        RecoveryPeriodInDays: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
 
  rrRBACCustomResourceLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rRBACCustomResource"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rCustomResourceLambdaExecutionRole.Arn
      Runtime: python3.12
      Timeout: 900
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/rbaccustomresource/rbac_custom_resource.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
 
  rRBACCustomResource:
    Type: Custom::rRBACCustomResource
    DependsOn:
      - rrRBACCustomResourceLambda
    Properties:
      ServiceToken: !GetAtt rrRBACCustomResourceLambda.Arn
      rRolesTable: !Sub "Workbench-${pPrefix}-rRolesTable"
      Changesetflag: "2025-07-02"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

# Lambda Roles
  rDatasourceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rUserExecutionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

      Policies:
        - PolicyName: CloudwatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CloudWatchLogsAccess
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
 
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: rDatasourcesTableAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                Resource: 
                  - !GetAtt rDatasourcesTable.Arn
                  - !GetAtt rActivityLogsTable.Arn
                  - !GetAtt rRolesTable.Arn
                  - !GetAtt rResourceAccessTable.Arn
                  - !Sub "${rDatasourcesTable.Arn}/index/CreatedBy-DatasourceName-index"
                  - !Sub "${rResourceAccessTable.Arn}/index/AccessKey-Index"

        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: S3AccessToDatasourceFolder
                Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${rDatasourceBucket}
                  - !Sub arn:aws:s3:::${rDatasourceBucket}/*
                  - !Sub arn:aws:s3:::${rDatasourceBucket}/datasources/*

      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

      Tags:
        - Key: Name
          Value: WorkbenchV2
        - Key: SWB-User
          Value: ServiceWorkbench

  rQueryParserExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rQueryParserExecutionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudwatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CloudWatchLogsAccess
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: QueryParserTableAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                Resource:
                  - !GetAtt rDatasourcesTable.Arn
                  - !GetAtt rSolutionsTable.Arn
                  - !GetAtt rWorkspacesTable.Arn
                  - !GetAtt rResourceAccessTable.Arn
                  - !Sub "${rDatasourcesTable.Arn}/index/DatasourceName-index"
                  - !Sub "${rSolutionsTable.Arn}/index/SolutionName-index"
                  - !Sub "${rWorkspacesTable.Arn}/index/WorkspaceName-index"
                  - !Sub "${rResourceAccessTable.Arn}/index/AccessKey-Index"
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: AllowS3AccessTosolutionBucket
                Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - arn:aws:s3:::develop-service-workbench-workspaces
                  - arn:aws:s3:::develop-service-workbench-workspaces/*
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
        - Key: Name
          Value: WorkbenchV2
        - Key: SWB-User
          Value: ServiceWorkbench

# Lambdas
  rRolesLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rRolesLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rRolesLambdaExecutionRole.Arn
      Runtime: python3.12
      Timeout: 900
      Environment:
        Variables:
          ROLES_TABLE: !Ref rRolesTable
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/roles/roles_lambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rUsersLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rUsersLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rUserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 900
      Environment:
        Variables:
          USER_TABLE_NAME: !Ref rUserTable
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          MISC_BUCKET: !Ref MiscBucket
          ROLES_TABLE: !Ref rRolesTable
          GLUE_JOB_NAME: !Ref rGlueJob
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchuserslambda/WorkbenchrUsersLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rDatasourcesLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rDatasourcesLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rDatasourceLambdaRole.Arn
      Runtime: python3.12
      Timeout: 900
      Environment:
        Variables:
          DATASOURCE_TABLE_NAME: !Ref rDatasourcesTable
          DATASOURCE_BUCKET: !Ref rDatasourceBucket
          ROLES_TABLE: !Ref rRolesTable
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          RESOURCE_ACCESS_TABLE: !Ref rResourceAccessTable
          USERS_TABLE: !Ref rUserTable
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchdatasourcelambda/WorkbenchDatasourceLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rChatLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Workspaces and Solutions Lambda Function"
      FunctionName: !Sub "${pPrefix}-rChatLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rChatLambdaRole.Arn
      Runtime: python3.12
      Timeout: 900
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchchatlambda/WorkbenchChat.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
      Environment:
        Variables:
          LOOK_UP_TABLE: !Ref rBedrockAgentLookupTable
          # CHAT_TABLE: !Ref rChatHistoryTable
          CHAT_TABLE: "Wokbench-chathistory"

  rShareLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Share Lambda Function"
      FunctionName: !Sub "${pPrefix}-rShareLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rWorkspaceLambdaExecutionRole.Arn
      Runtime: python3.13
      Timeout: 600
      Environment:
        Variables:
          ACTIVITY_LOGS_TABLE: !Ref rActivityLogsTable
          SOLUTIONS_TABLE: !Ref rSolutionsTable
          WORKSPACES_TABLE: !Ref rWorkspacesTable
          RESOURCE_ACCESS_TABLE: !Ref rResourceAccessTable
          ROLES_TABLE: !Ref rRolesTable
          USER_TABLE_NAME: !Ref rUserTable
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/sharelambda/ShareLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"
  
  rQueryParserLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Query Parser Lambda Function"
      FunctionName: !Sub "${pPrefix}-rQueryParserLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rQueryParserExecutionRole.Arn
      Runtime: python3.12
      Timeout: 900
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Environment:
        Variables:
          DATASOURCE_TABLE_NAME: !Ref rDatasourcesTable
          SOLUTION_TABLE_NAME: !Ref rSolutionsTable
          WORKSPACE_TABLE_NAME: !Ref rWorkspacesTable
          RESOURCE_ACCESS_TABLE: !Ref rResourceAccessTable
          SOLUTION_BUCKET_NAME: "develop-service-workbench-workspaces"
          USERS_TABLE: !Ref rUserTable
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchqueryparseragentlambda/WorkbenchQueryParserAgent.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rArchitectureAgentAGLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !ImportValue WorkspacesBucketArn
                  - !Sub
                    - "${BucketArn}/*"
                    - {BucketArn: !ImportValue WorkspacesBucketArn}
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !ImportValue WorkspacesBucketArn
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rArchitectureAgentAGLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Architecture Agent AG Lambda Function"
      FunctionName: !Sub "${pPrefix}-architecture-generation-lambda"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rArchitectureAgentAGLambdaRole.Arn
      Runtime: python3.12
      Timeout: 900
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Environment:
        Variables:
          WORKSPACES_BUCKET: !ImportValue "WorkspacesBucket"
          SOLUTIONS_TABLE: !Ref "rSolutionsTable"
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/architecutureagentag/ArchitectureAgentAG.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rCodeLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rCodeLambdaExecutionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudwatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CloudWatchLogsAccess
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CodeGenerationTableAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                Resource:
                  - !GetAtt rSolutionsTable.Arn
                  - !GetAtt rWorkspacesTable.Arn
                  - !GetAtt rUserTable.Arn
        - PolicyName: CostExplorerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CostExplorerAccess
                Effect: Allow
                Action:
                  - ce:GetCostAndUsage
                  - ce:GetDimensionValues
                  - ce:GetCostForecast
                Resource: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

  rCostLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Description: !Sub "${prDeploymentTrigger} - Cost Lambda Function"
      FunctionName: !Sub "${pPrefix}-rCostLambdaFunction"
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rCodeLambdaExecutionRole.Arn
      Runtime: python3.12
      Timeout: 900
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-1-ID"
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Private-Subnet-2-ID"
        SecurityGroupIds:
          - Fn::ImportValue:
              Fn::Sub: "${pVPCPrefix}-Lambda-SG-ID"
      Environment:
        Variables:
          SOLUTION_TABLE: !Ref "rSolutionsTable"
          WORKSPACE_TABLE: !Ref "rWorkspacesTable"
          USERS_TABLE: !Ref "rUserTable"
      Layers:
        - !ImportValue ServiceWorkbenchLambdaLayer
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/workbenchcostlambda/WorkbenchCostLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rArchitectureAgentAGLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rArchitectureAgentAGLambdaFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceArn: !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*

  rCodeGeneartorAgentAGLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rCodeGenerationLambda
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceArn: !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*

  rCFTGeneartorAgentAGLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rCFTGenerationAgentLambda
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceArn: !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*


# Lambda Permission for API Gateway to invoke Roles Lambda
  rrQueryParserLambdaFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rQueryParserLambdaFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceArn: !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*

  rrRolesLambdaFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rRolesLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*/*/*
     
  rrUsersLambdaFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rUsersLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*/*/*
  
  rrDatasourcesLambdaFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rDatasourcesLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*/*/*

  rrShareLambdaFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rShareLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*/*/*

  rVectorKnowledgeBase:
    Type: AWS::Bedrock::KnowledgeBase
    Properties:
      Name: !Sub "${pPrefix}-KnowledgeBase"
      Description: "Stores vectorized data in OpenSearch"
      RoleArn: !ImportValue "CustomResourceLambdaRoleARN"
      StorageConfiguration:
        Type: OPENSEARCH_MANAGED_CLUSTER
        OpensearchManagedClusterConfiguration:
          DomainArn: !ImportValue "OpenSearchDBArn"
          DomainEndpoint: !Join
            - ""
            - - "https://"
              - !ImportValue "OpenSearchEndpoint"
          FieldMapping: 
            VectorField: "bedrock-knowledge-base-default-vector"  
            TextField: "AMAZON_BEDROCK_TEXT_CHUNK"               
            MetadataField: "AMAZON_BEDROCK_METADATA"  
          VectorIndexName: !Sub "${pPrefix}_vector_index"
      KnowledgeBaseConfiguration:
        Type: VECTOR
        rVectorKnowledgeBaseConfiguration:
          EmbeddingModelArn: !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v2:0"

  rAuroraKnowledgeBase:
    Type: AWS::Bedrock::KnowledgeBase
    Properties:
      Name: !Sub "${pPrefix}-AuroraKB"
      Description: "Knowledge base using Aurora PostgreSQL"
      RoleArn: !ImportValue "CustomResourceLambdaRoleARN"
      KnowledgeBaseConfiguration:
        Type: "VECTOR"
        rVectorKnowledgeBaseConfiguration:
          EmbeddingModelArn: "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v2:0"
      StorageConfiguration:
        Type: "RDS"
        RdsConfiguration:
          ResourceArn: !ImportValue "AuroraDBClusterARN"
          CredentialsSecretArn: !ImportValue "AuroraDBSecretARN"
          DatabaseName: !ImportValue "AuroraDBName"
          TableName: !Sub "${pRAGPrefix}_aurora_table" 
          FieldMapping:
            VectorField: "embedding"
            TextField: "content"
            MetadataField: "metadata"
            PrimaryKeyField: "id" 

  rWebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub ${pPrefix}-Workbench-WebSocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  rIntegrationSendMessage:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref rWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${FunctionName}/invocations
        - {FunctionName: !Ref rChatLambdaFunction}
      IntegrationMethod: POST
      ConnectionType: INTERNET
      PayloadFormatVersion: "1.0"
      PassthroughBehavior: WHEN_NO_MATCH

  rIntegrationConnect:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref rWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${FunctionName}/invocations
        - {FunctionName: !Ref rChatLambdaFunction}
      IntegrationMethod: POST
      ConnectionType: INTERNET
      PayloadFormatVersion: "1.0"
      PassthroughBehavior: WHEN_NO_MATCH

  rIntegrationDisconnect:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref rWebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${FunctionName}/invocations
        - {FunctionName: !Ref rChatLambdaFunction}
      IntegrationMethod: POST
      ConnectionType: INTERNET
      PayloadFormatVersion: "1.0"
      PassthroughBehavior: WHEN_NO_MATCH
      
  rRouteConnect:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref rWebSocketApi
      RouteKey: $connect
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref rWebSocketAuthorizer
      Target: !Join ["/", ["integrations", !Ref rIntegrationConnect]]

  rRouteDisconnect:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref rWebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Join ["/", ["integrations", !Ref rIntegrationDisconnect]]

  rRouteSendMessage:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref rWebSocketApi
      RouteKey: sendMessage
      AuthorizationType: NONE
      Target: !Join ["/", ["integrations", !Ref rIntegrationSendMessage]]


  rDeployment:
    Type: AWS::ApiGatewayV2::rDeployment
    DependsOn:
      - rRouteConnect
      - rRouteDisconnect
      - rRouteSendMessage
    Properties:
      ApiId: !Ref rWebSocketApi
  
  rWebSocketAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      Name: !Sub "${pPrefix}-rWebSocketAuthorizer"
      ApiId: !Ref rWebSocketApi
      AuthorizerType: REQUEST
      IdentitySource:
        - route.request.querystring.token
      AuthorizerUri: !Sub
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${FunctionName}/invocations
        - {FunctionName: !Ref rLambdaAuthorizerFunction}

  rWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: !Ref prWebSocketStage
      AutoDeploy: true
      rDeploymentId: !Ref rDeployment
      ApiId: !Ref rWebSocketApi
      DefaultRouteSettings:
        DataTraceEnabled: false
        DetailedMetricsEnabled: false
        LoggingLevel: OFF

  rAuthorizerrLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rLambdaAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 
        - "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWebSocketApi}/*"
        - rWebSocketApi: !Ref rWebSocketApi

  rLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rChatLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWebSocketApi}/*"

  rWorkbenchLambdaAuthorizerInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rLambdaAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${rWorkbenchApi}/*    


  rrCFTGenerationAgentLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pPrefix}-rrCFTGenerationAgentLambdaRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::develop-service-workbench-workspaces/*"
                  - !Sub "arn:aws:s3:::develop-service-workbench-workspaces"
      
        - PolicyName: ServiceCatalogAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - servicecatalog:CreateProduct
                  - servicecatalog:AssociateProductWithPortfolio
                  - servicecatalog:ProvisionProduct
                  - servicecatalog:DescribeRecord
                  - servicecatalog:DescribeProvisionedProduct
                Resource: "*"
      
        - PolicyName: CloudFormationAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStackResources
                Resource: "*"
      
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:UpdateItem
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Workbench-*"
      
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock-agent-runtime:InvokeAgent
                Resource: "*"
      
        - PolicyName: StepFunctionsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                  - states:DescribeExecution
                Resource: "*"
      
        - PolicyName: STSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: "*"
    
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
    
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rCFTGenerationAgentLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${pPrefix}-rCFTGenerationAgentLambda"
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt rrCFTGenerationAgentLambdaRole.Arn
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          ENVIRONMENT: !Sub "${pPrefix}"
          SOLUTIONS_TABLE: !Ref rSolutionsTable
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
      Code:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: !Sub "lambda-${pLambdaArtifactVersion}-${pPrefix}/cftgenerationagentlambda/rCFTGenerationAgentLambda.zip"
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rChatHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'Workbench-${pPrefix}-ChatHistory'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ChatId
          AttributeType: S
        - AttributeName: Timestamp
          AttributeType: S
        - AttributeName: MessageId
          AttributeType: S
      KeySchema:
        - AttributeName: ChatId
          KeyType: HASH
        - AttributeName: Timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: MessageIdIndex
          KeySchema:
            - AttributeName: MessageId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: "WorkbenchV2"
        - Key: SWB-User
          Value: "ServiceWorkbench"

  rDailyMidnightScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub 'Workbench-${pPrefix}-AuroraEB'
      Description: Triggers Lambda function daily at 12:00 AM UTC (Monday-Saturday)
      ScheduleExpression: 'cron(0 0 ? * MON-SAT *)'
      State: DISABLED
      Targets:
        - Arn: !GetAtt rUsersLambda.Arn
          Id: DailyMidnightLambdaTarget
          Input: !Sub |
            {
              "action": "app"
            }

  rSundayMidnightScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub 'Workbench-${pPrefix}-EB'
      Description: Triggers Lambda function every Sunday at 12:00 AM UTC with special parameters
      ScheduleExpression: 'cron(0 0 ? * SUN *)'
      State: DISABLED
      Targets:
        - Arn: !GetAtt rUsersLambda.Arn
          Id: SundayMidnightLambdaTarget
          Input: !Sub |
            {
              "action": "docsapp"
            }

  DailyrLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rUsersLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt rDailyMidnightScheduleRule.Arn

  SundayrLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref rUsersLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt rSundayMidnightScheduleRule.Arn



Outputs:

  oWorkspaceLambdaFunctionName:
    Description: Name of the Workspace Lambda function
    Value: !Ref rWorkspacesAndSolutionsLambdaFunction
  oApiUrl:
    Description: "Invoke URL for the deployed API"
    Value: !Sub "https://${rWorkbenchApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
  oCloudfrontDistributionId:
    Description: CloudFront distribution ID
    Value: !GetAtt rWebsiteDistribution.Id
    Export:
      Name: !Sub "${pPrefix}-CloudFrontDistributionId"

  oCloudFrontDomainName:
    Description: Domain name of the CloudFront distribution
    Value: !GetAtt rWebsiteDistribution.DomainName
    Export:
      Name: !Sub "${pPrefix}-CloudFrontDomainName"
    
  oCognitoUserPoolId:
    Value: !Ref rUserPool
    Export:
      Name: !Sub "${pPrefix}-CognitoUserPoolId"

  oCognitoAppClientId:
    Value: !Ref rUserPoolClient
    Export:
      Name: !Sub "${pPrefix}-CognitoAppClientId"

  oCognitoRegion:
    Value: !Ref "AWS::Region"
    Export:
      Name: !Sub "${pPrefix}-Region"

  oWebSocketApiUrl:
    Value: !Sub "wss://${rWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${pWebSocketStage}"
    Export:
      Name: !Sub "${pPrefix}-WebSocketApiUrl"
    
  oCognitoUserPoolDomainURL:
    Value: !Sub "${pPrefix}-${AWS::AccountId}-auth"
    Export:
      Name: !Sub "${pPrefix}-CognitoUserPoolDomainURL"
