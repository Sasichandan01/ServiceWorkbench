AWSTemplateFormatVersion: '2010-09-09'
Description: Service Workbench V2 Infrastructure with VPC

Parameters:
  pApplicationPrefix:
    Type: String
    Default: "wb-WorkBench"
    Description: Prefix for the application resources
  
  pArtifactsBucketName:
    Type: String
    Default: "service-workbench-artifacts"
    Description: Name of the S3 bucket for artifacts
  
  pVPCCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC
  
  pVPCPrefix:
    Type: String
    Default: WorkbenchVPC
    Description: Environment name prefix for VPC resources

  pDatabaseName: 
    Type: String
    Default: workbenchdb
    Description: Database name for Aurora

Resources:

  # VPC Resources
  rVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-VPC

  rInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-IGW

  rInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref rInternetGateway
      VpcId: !Ref rVPC

  rPublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref rVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Public-Subnet-AZ1

  rPublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref rVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Public-Subnet-AZ2

  rPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref rVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Private-Subnet-AZ1

  rPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref rVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.4.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Private-Subnet-AZ2

  rNatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: rInternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-NAT-EIP

  rNatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt rNatGatewayEIP.AllocationId
      SubnetId: !Ref rPublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-NAT-Gateway

  rPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref rVPC
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Public-Routes

  rDefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: rInternetGatewayAttachment
    Properties:
      RouteTableId: !Ref rPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref rInternetGateway

  rPublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref rPublicRouteTable
      SubnetId: !Ref rPublicSubnet1

  rPublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref rPublicRouteTable
      SubnetId: !Ref rPublicSubnet2

  rPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref rVPC
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Private-Routes

  rDefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref rPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref rNatGateway

  rPrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref rPrivateRouteTable
      SubnetId: !Ref rPrivateSubnet1

  rPrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref rPrivateRouteTable
      SubnetId: !Ref rPrivateSubnet2

  rPublicNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref rVPC
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Public-NACL

  rPrivateNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref rVPC
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Private-NACL

  # Public NACL Rules
  rPublicNACLInboundAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPublicNACL
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0

  rPublicNACLOutboundAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPublicNACL
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0

  # Private NACL Rules
  rPrivateNACLInboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 443
        To: 443

  rPrivateNACLInboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 101
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 80
        To: 80

  rPrivateNACLInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      Egress: false
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  rPrivateNACLInboundVPCTraffic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 120
      Protocol: -1
      RuleAction: allow
      Egress: false
      CidrBlock: !Ref VPCCidr

  rPrivateNACLOutboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 443
        To: 443

  rPrivateNACLOutboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 101
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 80
        To: 80
 
  rPrivateNACLOutboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  rPrivateNACLOutboundVPCTraffic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref rPrivateNACL
      RuleNumber: 120
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: !Ref VPCCidr
        
  # NACL Subnet Associations
  rAssociatePrivateNACLSubnet1:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref rPrivateSubnet1
      NetworkAclId: !Ref rPrivateNACL

  rAssociatePrivateNACLSubnet2:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref rPrivateSubnet2
      NetworkAclId: !Ref rPrivateNACL

  rAssociatePublicNACLSubnet1:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref rPublicSubnet1
      NetworkAclId: !Ref rPublicNACL

  rAssociatePublicNACLSubnet2:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref rPublicSubnet2
      NetworkAclId: !Ref rPublicNACL

  # Security Groups
  rLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for VPC Lambdas
      GroupName: !Sub ${pVPCPrefix}-Lambda-SG
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref VPCCidr
          Description: HTTPS from VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS to internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP to internet
      Tags: 
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Lambda-SG
      VpcId: !Ref rVPC

  rEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for VPC Endpoints
      GroupName: !Sub ${pVPCPrefix}-Endpoint-SG
      SecurityGroupEgress: 
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound
      SecurityGroupIngress: 
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref rLambdaSecurityGroup
          Description: HTTPS from Lambda SG
      Tags: 
        - Key: Name
          Value: !Sub ${pVPCPrefix}-Endpoint-SG
      VpcId: !Ref rVPC  

  # VPC Endpoints
  rS3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref rVPC
      RouteTableIds:
        - !Ref rPrivateRouteTable
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      VpcEndpointType: Gateway
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-S3-Endpoint

  rDynamoDBEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref rVPC
      RouteTableIds:
        - !Ref rPrivateRouteTable
      ServiceName: !Sub com.amazonaws.${AWS::Region}.dynamodb
      VpcEndpointType: Gateway
      Tags:
        - Key: Name
          Value: !Sub ${pVPCPrefix}-DynamoDB-Endpoint

  # S3 bucket for artifacts
  rWebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${pApplicationPrefix}-service-workbench-website"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  # S3 bucket for logs
  rLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${pApplicationPrefix}-service-workbench-logs"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rWorkspacesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${pApplicationPrefix}-service-workbench-workspaces"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      Tags:
        - Key: Name
          Value: "WorkbenchV2"


  rServiceWorkbenchLambdaLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: "ServiceWorkbenchLambdaLayer"
      Description: "Service Workbench Lambda Layer"
      Content:
        S3Bucket: !Ref pArtifactsBucketName
        S3Key: layer/layer.zip
      CompatibleRuntimes:
        - python3.12

  rOpenSearchDB:
    Type: AWS::OpenSearchService::Domain
    Properties:
      DomainName: !Sub "${pApplicationPrefix}-opensearchdb"
      EngineVersion: 'OpenSearch_2.17'
      ClusterConfig:
        InstanceCount: 3
        InstanceType: t3.medium.search
        ZoneAwarenessEnabled: true
        ZoneAwarenessConfig: 
          AvailabilityZoneCount: 3
        WarmEnabled: false
        MultiAZWithStandbyEnabled: false
      EBSOptions:
        EBSEnabled: true
        VolumeType: gp3
        VolumeSize: 10
        Iops: 3000
        Throughput: 125
      EncryptionAtRestOptions:
        Enabled: true
      NodeToNodeEncryptionOptions:
        Enabled: true
      DomainEndpointOptions:
        EnforceHTTPS: true
      AccessPolicies:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: "*"             
            Action: "es:*"
            Resource: "*"
      AdvancedOptions:
        indices.fielddata.cache.size: "20"
        rest.action.multi.allow_explicit_index: "true"
        indices.query.bool.max_clause_count: "1024"
      AdvancedSecurityOptions:
        Enabled: true
        InternalUserDatabaseEnabled: false
        MasterUserOptions:
          MasterUserARN: !GetAtt rRAGCustomResourceLambdaRole.Arn
      OffPeakWindowOptions:
        Enabled: true
        OffPeakWindow: 
          WindowStartTime: 
            Hours: 0
            Minutes: 0
      SnapshotOptions:
        AutomatedSnapshotStartHour: 0
      IPAddressType: dualstack
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rRAGCustomResourceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${pApplicationPrefix}-RAGCustomResourceLambdaRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - bedrock.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: VectorStoreAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "es:ESHttp*"
                  - "es:DescribeDomain"
                  - "es:ListDomainNames"
                  - "rds-data:ExecuteStatement"
                  - "rds-data:BatchExecuteStatement"
                  - "rds:DescribeDBClusters"
                  - "secretsmanager:GetSecretValue"
                  - "bedrock:InvokeModel"
                  - "bedrock:Retrieve"
                  - "bedrock:RetrieveAndGenerate"
                  - "bedrock:CreateKnowledgeBase"
                Resource: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rRAGCustomResourcePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: ClusterAccessPolicy
      Roles:
        - !Ref rRAGCustomResourceLambdaRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - es:ESHttpGet
              - es:ESHttpPost
              - es:ESHttpPut
              - es:ESHttpDelete
              - es:ESHttpHead
            Resource:
              - !Sub "arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${rOpenSearchDB}/*"
          - Effect: Allow
            Action:
              - rds-data:ExecuteStatement
              - rds-data:BatchExecuteStatement
              - rds-data:BeginTransaction
              - rds-data:CommitTransaction
              - rds-data:RollbackTransaction
            Resource:
              - !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${rAuroraDBCluster}"
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - !GetAtt rAuroraDBCluster.MasterUserSecret.SecretArn
          - Effect: Allow
            Action: s3:*
            Resource: "*"
            

  rRAGCustomResourceLambda:
    Type: AWS::Lambda::Function
    Properties:
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      FunctionName: !Sub "${pApplicationPrefix}-RAGCustomResourceLambda"
      Timeout: 900
      Role: !GetAtt rRAGCustomResourceLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Ref AWS::Region
      Code: 
        S3Bucket: service-workbench-artifacts
        S3Key: lambda/ragcustomresourcelambda/rag_custom_resource_lambda.zip
      VpcConfig:
        SubnetIds:
          - !Ref rPrivateSubnet1
          - !Ref rPrivateSubnet2
        SecurityGroupIds:
          - !Ref rLambdaSecurityGroup
      Layers:
        - !Ref rServiceWorkbenchLambdaLayer
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rAuroraSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Private Subnets for Aurora DB"
      SubnetIds:
        - !Ref rPrivateSubnet1
        - !Ref rPrivateSubnet2
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rAuroraDBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      AutoMinorVersionUpgrade: false
      BackupRetentionPeriod: 7
      DatabaseName: !Ref pDatabaseName
      DBClusterIdentifier: !Sub "${pApplicationPrefix}-auroradbcluster"
      DBClusterParameterGroupName: default.aurora-postgresql15
      DeletionProtection: false
      EnableIAMDatabaseAuthentication: true
      EnableHttpEndpoint: true
      Engine: aurora-postgresql
      EngineMode: provisioned
      EngineVersion: 15.4
      MasterUsername: postgres
      ManageMasterUserPassword: true
      DBSubnetGroupName: !Ref rAuroraSubnetGroup
      VpcSecurityGroupIds:
        - !Ref rEndpointSecurityGroup
      NetworkType: IPV4
      StorageType: aurora
      PerformanceInsightsEnabled: true
      PerformanceInsightsRetentionPeriod: 7
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.5
        MaxCapacity: 2
      Port: 5432
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rAuroraDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${pApplicationPrefix}-auroradbclusterinstance"
      DBClusterIdentifier: !Ref rAuroraDBCluster
      DBInstanceClass: db.serverless
      Engine: aurora-postgresql
      EnablePerformanceInsights: true
      PubliclyAccessible: false
      PerformanceInsightsRetentionPeriod: 7
      Tags:
        - Key: Name
          Value: "WorkbenchV2"

  rOpenSearchClusterCustomResource:
    Type: "AWS::CloudFormation::CustomResource"
    Properties:
      ServiceToken: !GetAtt rRAGCustomResourceLambda.Arn
      changesetflag: '25'
      OS_ENDPOINT: !GetAtt rOpenSearchDB.DomainEndpoint
      ClusterARN: !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${rAuroraDBCluster}"
      DatabaseName: !Ref pDatabaseName
      SecretARN: !GetAtt rAuroraDBCluster.MasterUserSecret.SecretArn

Outputs:
  oVPCId:
    Description: VPC ID
    Value: !Ref rVPC
    Export:
      Name: !Sub ${pVPCPrefix}-VPC-ID

  oVPCCidr:
    Description: VPC CIDR Block
    Value: !Ref pVPCCidr
    Export:
      Name: !Sub ${pVPCPrefix}-VPC-CIDR

  oPublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref rPublicSubnet1
    Export:
      Name: !Sub ${pVPCPrefix}-Public-Subnet-1-ID

  oPublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref rPublicSubnet2
    Export:
      Name: !Sub ${pVPCPrefix}-Public-Subnet-2-ID

  oPrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref rPrivateSubnet1
    Export:
      Name: !Sub ${pVPCPrefix}-Private-Subnet-1-ID

  oPrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref rPrivateSubnet2
    Export:
      Name: !Sub ${pVPCPrefix}-Private-Subnet-2-ID

  oLambdaSecurityGroupId:
    Description: Lambda Security Group ID
    Value: !Ref rLambdaSecurityGroup
    Export:
      Name: !Sub ${pVPCPrefix}-Lambda-SG-ID

  oEndpointSecurityGroupId:
    Description: Endpoint Security Group ID
    Value: !Ref rEndpointSecurityGroup
    Export:
      Name: !Sub ${pVPCPrefix}-Endpoint-SG-ID

  oNATGatewayId:
    Description: NAT Gateway ID
    Value: !Ref rNatGateway
    Export:
      Name: !Sub ${pVPCPrefix}-NAT-Gateway-ID

  oWebsiteBucketName:
    Description: Website bucket name
    Value: !Ref rWebsiteBucket
    Export:
      Name: "WebsiteBucketName"

  oWebsiteBucketArn:
    Description: Website bucket ARN
    Value: !GetAtt rWebsiteBucket.Arn
    Export:
      Name: "WebsiteBucketArn"

  oWebsiteBucketRegionalDomainName:
    Description: Website bucket regional domain name
    Value: !GetAtt rWebsiteBucket.RegionalDomainName
    Export:
      Name: "WebsiteBucketRegionalDomainName"

  oLogsBucketDomainName:
    Description: Logs bucket domain name
    Value: !GetAtt rLogsBucket.DomainName
    Export:
      Name: "LogsBucketDomainName"

  oLogsBucketName:
    Description: Name of the logs S3 bucket
    Value: !Ref rLogsBucket
    Export:
      Name: "LogsBucketName"

  oLogsBucketArn:
    Description: Logs bucket ARN
    Value: !GetAtt rLogsBucket.Arn
    Export:
      Name: "LogsBucketArn"

  oWorkspacesBucketName:
    Description: Name of workspaces S3 bucket
    Value: !Ref rWorkspacesBucket
    Export:
      Name: "WorkspacesBucket"
  
  oWorkspacesBucketArn:
    Description: Workspaces bucket ARN
    Value: !GetAtt rWorkspacesBucket.Arn
    Export:
      Name: "WorkspacesBucketArn"

  oServiceWorkbenchLambdaLayer:
    Description: Name of the service workbench lambda layer
    Value: !Ref rServiceWorkbenchLambdaLayer
    Export:
      Name: "ServiceWorkbenchLambdaLayer"

  oOpenSearchDBEndpoint:
    Value: !GetAtt rOpenSearchDB.DomainEndpoint
    Description: The endpoint of the OpenSearch cluster
    Export:
      Name: "OpenSearchEndpoint"

  oOpenSearchDBArn:
    Value: !GetAtt rOpenSearchDB.Arn
    Description: The ARN of the OpenSearch cluster
    Export:
      Name: "OpenSearchDBArn"

  oRAGCustomResourceLambdaRole:
    Value: !GetAtt rRAGCustomResourceLambdaRole.Arn
    Description: The ARN of the custom resource lambda role
    Export:
      Name: "CustomResourceLambdaRoleARN"

  oAuroraDBClusterARN:
    Value: !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${rAuroraDBCluster}"
    Description: The ARN of the Aurora DB cluster
    Export:
      Name: "AuroraDBClusterARN"

  oAuroraDBClusterSecret:
    Value: !GetAtt rAuroraDBCluster.MasterUserSecret.SecretArn
    Description: The secret ARN for the Aurora DB cluster
    Export:
      Name: "AuroraDBSecretARN"

  oAuroraDBName:
    Value: !Ref pDatabaseName
    Description: The name of the database
    Export:
      Name: "AuroraDBName"
